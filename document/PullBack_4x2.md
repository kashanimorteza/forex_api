<!--------------------------------------------------------------------------------- Description --->
# Poolback 4x
```
Ichimoku Dual Cloud Switch Backtest
```
```
استراتژی پولبک ۴ برابر  
مبتنی بر دو ابر ایچیموکو – تریگر سویچ کومو در تنظیمات استاندارد + فیلتر روند در تنظیمات بزرگ‌تر
```
```
 جهت‌گیری اصلی: دنباله‌رو روند بزرگ (ابر Ichi2) + پولبک کوتاه‌مدت (سویچ ابر Ichi1)
```
```
واحد محاسبه pnl: تفاوت قیمت خام (بدون در نظر گرفتن حجم معامله، اسپرد، کمیسیون یا اسلیپیج)
```

<!--------------------------------------------------------------------------------- Parameters --->
<br><br>

## Parameters

<!----------------name--->
### name
```
این پارامتر برای تعیین نام استراتژی می‌باشد
```
```python
name='poolback_4x'
```
<!----------------time_frame--->
### time_frame
```
تایم‌فریم
```
```python
time_frame='1min'
```
<!----------------region--->
### region
```
این پارامتر برای تعیین نام استراتژی می‌باشد
```
```python
region='UTC'
```
<!----------------time_from--->
### time_from
```
زمان شروع مجاز معامله
```
```python
time_from='00:00:00'
```
<!----------------time_to--->
### time_to
```
زمان پایان مجاز معامله
```
```python
time_to='21:00:00'
```
<!----------------max_order--->
### max_order
```
حداکثر پوزیشن همزمان
```
```python
max_order=1
```







## پارامترهای ایچیموکو

Ichi1 (تنظیمات استاندارد – تریگر سویچ):
- Tenkan-sen: ۹ کندل
- Kijun-sen: ۲۶ کندل
- Senkou Span B: ۷۸ کندل
- Senkou Span A: میانگین Tenkan و Kijun

Ichi2 (تنظیمات بزرگ‌تر – فیلتر روند کلی):
- Tenkan-sen: ۳۶ کندل
- Kijun-sen: ۱۰۴ کندل
- Senkou Span B: ۲۳۴ کندل
- Senkou Span A: میانگین Tenkan و Kijun

## تعاریف مهم

سویچ نزولی کومو Ichi1 (تریگر خرید):  
در کندل فعلی: قیمت بسته شدن زیر SpanA1 و SpanB1 + SpanA1 زیر SpanB1  
و در کندل‌های قبلی (جستجو به عقب): حداقل یک بار SpanA1 بالای SpanB1 بوده باشد  
(کندل‌هایی که SpanA1 برابر SpanB1 است نادیده گرفته می‌شود و جستجو ادامه پیدا می‌کند)

سویچ صعودی کومو Ichi1 (تریگر فروش):  
در کندل فعلی: قیمت بسته شدن بالای SpanA1 و SpanB1 + SpanA1 بالای SpanB1  
و در گذشته نزدیک: حداقل یک بار SpanA1 زیر SpanB1 بوده باشد

کومو صعودی Ichi2 (فیلتر خرید): SpanA2 > SpanB2  
کومو نزولی Ichi2 (فیلتر فروش): SpanA2 < SpanB2

تنکن-کیجن صعودی Ichi2 (فیلتر خرید): Tenkan2 > Kijun2  
تنکن-کیجن نزولی Ichi2 (فیلتر فروش): Tenkan2 < Kijun2

استاپ اولیه خرید: پایین‌ترین Low در ۷۸ کندل گذشته  
استاپ اولیه فروش: بالاترین High در ۷۸ کندل گذشته

## شرایط ورود

ورود فقط در کندلی انجام می‌شود که سویچ کومو Ichi1 در همان کندل رخ داده باشد.

### شرایط خرید (Long)

- سویچ نزولی کومو Ichi1 رخ داده باشد
- کومو Ichi2 صعودی باشد (SpanA2 > SpanB2)
- تنکن-کیجن Ichi2 صعودی باشد (Tenkan2 > Kijun2)

استاپ اولیه: پایین‌ترین Low ۷۸ کندل گذشته  
(فقط اگر استاپ پایین‌تر از قیمت بسته شدن باشد → معامله معتبر است)

### شرایط فروش (Short)

- سویچ صعودی کومو Ichi1 رخ داده باشد
- کومو Ichi2 نزولی باشد (SpanA2 < SpanB2)
- تنکن-کیجن Ichi2 نزولی باشد (Tenkan2 < Kijun2)

استاپ اولیه: بالاترین High ۷۸ کندل گذشته  
(فقط اگر استاپ بالاتر از قیمت بسته شدن باشد → معامله معتبر است)

## مدیریت معامله و شرایط خروج

نقطه ورود: قیمت بسته شدن کندل سیگنال (Close)

تیک‌پرافیت‌ها (نسبت به ریسک – R:R):  
1 برابر، ۲ برابر، ۳ برابر، ۴ برابر، ۵ برابر، ۶ برابر، ۷ برابر، ۴ برابر، ۵ برابر، ۱۰ برابر، ۱۱ برابر

تریلینگ استاپ:  
بعد از زدن هر تیک‌پرافیت، استاپ به سطح تیک‌پرافیت قبلی منتقل می‌شود  
(مثال: بعد TP1 → استاپ به نقطه ورود می‌رود | بعد TP2 → استاپ به TP1 می‌رود و ...)

خروج با استاپ لاس:  
اگر Low کندل ≤ استاپ (خرید) یا High کندل ≥ استاپ (فروش) → پوزیشن بسته می‌شود

خروج اجباری:  
اگر پوزیشن تا انتهای داده‌ها باز بماند → با قیمت بسته شدن آخرین کندل بسته می‌شود

## خروجی‌های تابع 

- df: داده اصلی + تمام خطوط ایچیموکو + ستون‌های سیگنال، قیمت ورود و استاپ
- trades_df: جدول معاملات بسته‌شده (زمان ورود و خروج، نوع معامله، pnl، دلیل خروج و ...)
- total_pnl: مجموع سود/زیان تمام معاملات (بر اساس تفاوت قیمت خام)


## خلاصه شبه‌کد منطق اصلی

برای هر کندل بسته‌شده در بازه ۰۰:۰۰–۲۱:۰۰:

اگر سویچ نزولی Ichi1 رخ داد و SpanA2 > SpanB2 و Tenkan2 > Kijun2:  
    → ورود خرید  
    استاپ = پایین‌ترین Low ۷۸ کندل گذشته  
    سطوح TP = [1, 2, 3, 4, 5, 6, 7, 4, 5, 10, 11]

اگر سویچ صعودی Ichi1 رخ داد و SpanA2 < SpanB2 و Tenkan2 < Kijun2:  
    → ورود فروش  
    استاپ = بالاترین High ۷۸ کندل گذشته  
    سطوح TP = همان لیست بالا
